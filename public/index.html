<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EEPROM KM Tool</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f7f7f7; padding: 20px; }
    .container { max-width: 520px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #333; }
    label { display: block; margin-top: 15px; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; }
    .result { margin-top: 15px; padding: 10px; background: #eee; border-radius: 8px; white-space: pre-line; }
    .preview { margin-top: 16px; text-align: center; }
    .preview img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; }
    small.note { color:#666 }
  </style>
</head>
<body>
  <div class="container">
    <h2>EEPROM KM Tool</h2>

    <!-- SELECT de modelos -->
    <label for="model">Modelo:</label>
    <select id="model" name="model">
      <option value="titan160">Titan 160</option>
      <option value="xre190">XRE 190</option>
      <option value="biz2018">Biz 2018</option>
      <option value="cb500x2023">CB 500X 2023</option>
      <option value="crosser150">Crosser 150</option>
      <option value="cbtwister24c02">CB Twister (24C02)</option>
      <option value="xt66024c02">XT660 (24C02)</option>
      <option value="cb300">CB 300</option>
      <option value="broz24C04">Broz (24C04)</option>
       <option value="xre300_2018_93c66">Honda XRE 300 2018 (93C66)</option>
      <option value="xre300_2014_24c02">XRE 300 2014 (24C02)</option>
    </select>

    <!-- Pré-visualização da imagem -->
    <div class="preview">
      <img id="panelImg" src="/static/img/titan160.png?v=1" alt="Painel selecionado"
           onerror="this.onerror=null; this.src='/static/img/placeholder.png';">
      <div><small class="note">As imagens ficam em <code>public/img/&lt;modelo&gt;.png</code>.</small></div>
    </div>

    <!-- GERAR BIN -->
    <form id="generateForm" style="margin-top:18px;">
      <label for="new_mileage">Nova Quilometragem:</label>
      <input type="number" id="new_mileage" name="new_mileage" required min="0" />
      <small class="note">Para CB Twister (24C02), XT660 (24C02)  o limite é 99.999.</small>
      <button type="submit" style="margin-top:10px;">Gerar Arquivo BIN</button>
    </form>

    <hr/>

    <!-- LER KM -->
    <form id="readForm" method="post" action="/ler-km" enctype="multipart/form-data">
      <input type="hidden" name="model" id="read_model">
      <label for="binfile">Enviar Arquivo BIN para Leitura:</label>
      <input type="file" id="binfile" name="binfile" accept=".bin" required />
      <button type="submit">Ler KM do Arquivo</button>
    </form>

    <div class="result" id="resultado"></div>
  </div>

  <script>
    const modelSelect = document.getElementById('model');
    const mileageInput = document.getElementById('new_mileage');
    const imgEl = document.getElementById('panelImg');
    const readModelHidden = document.getElementById('read_model');
    const resultado = document.getElementById('resultado');

    function updateForModel() {
      const m = modelSelect.value;

      // Limite de km
      if (['cbtwister24c02', 'xt66024c02', 'xre300_2014_24c02'].includes(m)) {
        mileageInput.max = 99999;
      } else {
        mileageInput.removeAttribute('max');
      }

      // Atualiza imagem
      imgEl.src = '/static/img/' + m + '.png?v=1';

      // Atualiza hidden do form de leitura
      readModelHidden.value = m;
    }

    modelSelect.addEventListener('change', updateForModel);
    window.addEventListener('DOMContentLoaded', updateForModel);

    // Gerar BIN (fetch + blob)
    document.getElementById('generateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      resultado.textContent = 'Gerando...';

      const model = modelSelect.value;
      const new_mileage = document.getElementById('new_mileage').value;

      try {
        const resp = await fetch('/alterar-e-baixar-template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model, new_mileage })
        });

        if (!resp.ok) {
          const errText = await resp.text();
          resultado.textContent = 'Erro: ' + errText;
          return;
        }

        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${model}_${new_mileage}km.bin`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        resultado.textContent = 'Arquivo gerado com sucesso.';
      } catch (err) {
        resultado.textContent = 'Erro de rede: ' + err.message;
      }
    });
  </script>
</body>
</html>
